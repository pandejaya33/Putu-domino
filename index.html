<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domino Mystic Final Pro</title>
    <style>
        body { background: radial-gradient(circle, #0a4d28 0%, #052915 100%); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .box { background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; border: 2px solid #ffd700; margin-top: 30px; text-align: center; width: 320px; display: flex; flex-direction: column; gap: 15px; }
        input, select { padding: 12px; border-radius: 8px; border: none; text-align: center; font-weight: bold; }
        .btn-gold { background: linear-gradient(#ffd700, #b8860b); color: #000; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; transition: 0.3s; }
        .btn-gold:disabled { background: #444; color: #888; cursor: not-allowed; }
        
        #playerList { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; border: 1px solid #ffd700; }
        .player-name { display: inline-block; margin: 5px; padding: 5px 10px; background: #ffd700; color: black; border-radius: 20px; font-weight: bold; font-size: 11px; }
        .ready-dot { color: #00ff00; margin-left: 5px; }

        .domino-card { background: #ffcc00; border: 2px solid #000; border-radius: 12px; width: 75px; height: 130px; margin: 8px; display: flex; flex-direction: column; justify-content: space-around; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer; position: relative; }
        .card-half { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 50px; height: 50px; gap: 3px; }
        .dot { background: #cc0000; border-radius: 50%; width: 12px; height: 12px; visibility: hidden; }
        .dot.active { visibility: visible; }
        .line { width: 90%; height: 3px; background: #000; margin: 2px 0; border-radius: 2px; }
        
        .domino-card.closed { background: #1a1a1a; border-color: #ffd700; }
        .domino-card.closed .card-half, .domino-card.closed .line { display: none !important; }
        .domino-card.closed::after { content: "?"; position: absolute; font-size: 60px; color: #cc0000; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); display: block; }
        #player-label { font-size: 1.2em; color: #ffd700; margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div id="lobby" class="box">
        <h1 style="color:#ffd700; margin:0;">DOMINO MYSTIC</h1>
        <input type="text" id="pName" placeholder="Nama Kamu">
        <input type="text" id="rCodeInput" placeholder="Kode Room">
        <select id="gameMode">
            <option value="spirit">Mode Spirit (Max 3)</option>
            <option value="bererong">Mode Bererong (Max 4)</option>
        </select>
        <button id="btnBuat" class="btn-gold">BUAT ROOM</button>
        <button id="btnGabung" class="btn-gold" style="background: #444; color: white;">GABUNG</button>
    </div>

    <div id="gameRoom" style="display:none; text-align:center; width: 100%; padding-top: 20px;">
        <h2 id="displayKode" style="color:#ffd700;"></h2>
        
        <div style="width: 320px; margin: 0 auto;">
            <p style="margin-bottom: 5px; font-size: 12px; color: #ffd700;">PEMAIN DI ROOM:</p>
            <div id="playerList"></div>
        </div>

        <div id="player-label"></div>
        <div id="cardArea" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
        
        <div id="actionArea" style="margin-top: 20px;">
            <button id="btnTarik" class="btn-gold" style="width:250px;">TARIK KARTU</button>
            <button id="btnGas" class="btn-gold" style="width:250px; display:none; background: linear-gradient(#00ff00, #008000); color: white;">GAS! ðŸš€</button>
        </div>

        <button id="btnMainLagi" style="background: white; color: black; padding: 10px 20px; border-radius: 8px; font-weight: bold; border: none; margin-top: 20px; cursor: pointer;">MAIN LAGI (RESET)</button>
        <p style="font-size: 12px; color: #aaa; margin-top: 10px;">Sentuh kartu untuk buka/tutup</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDt4C2gQuyCS28359YP0nryXpv_ASqra8U",
            authDomain: "putu-domino-7fa82.firebaseapp.com",
            projectId: "putu-domino-7fa82",
            storageBucket: "putu-domino-7fa82.firebasestorage.app",
            messagingSenderId: "721819699355",
            appId: "1:721819699355:web:feec9dcc605643d3bcde3e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const pId = Math.random().toString(36).substring(7);
        const dotPatterns = [[], [4], [0, 8], [0, 4, 8], [0, 2, 6, 8], [0, 2, 4, 6, 8], [0, 3, 6, 2, 5, 8]];

        function createDots(num) {
            let html = '<div class="card-half">';
            const pattern = dotPatterns[num];
            for(let i=0; i<9; i++) { html += `<div class="dot ${pattern.includes(i) ? 'active' : ''}"></div>`; }
            return html + '</div>';
        }

        function aktifkanRoom(rId) {
            document.getElementById("lobby").style.display = "none";
            document.getElementById("gameRoom").style.display = "block";
            document.getElementById("displayKode").innerText = "KODE: " + rId;

            onSnapshot(doc(db, "rooms", rId), (snap) => {
                if(!snap.exists()) return;
                const data = snap.data();
                const players = data.players;
                const me = players.find(p => p.id === pId);
                
                // Cek apakah semua sudah tekan GAS
                const everyoneReady = players.every(p => p.ready === true);
                
                // Update UI Daftar Pemain
                document.getElementById("playerList").innerHTML = players.map(p => `
                    <span class="player-name">${p.name} (${p.cards.length} KRT) ${p.ready ? '<b class="ready-dot">âœ“</b>' : ''}</span>
                `).join('');

                if(me) {
                    document.getElementById("player-label").innerText = "KARTU ANDA (" + me.name + ")";
                    document.getElementById("cardArea").innerHTML = me.cards.map((c) => {
                        const [top, bot] = c.split('/');
                        return `<div class="domino-card closed" onclick="this.classList.toggle('closed')">${createDots(parseInt(top))}<div class="line"></div>${createDots(parseInt(bot))}</div>`;
                    }).join('');

                    // LOGIKA TOMBOL GAS VS TARIK
                    if (me.cards.length === 1 && !me.ready) {
                        document.getElementById("btnTarik").style.display = "none";
                        document.getElementById("btnGas").style.display = "inline-block";
                    } else if (me.cards.length === 1 && me.ready && !everyoneReady) {
                        document.getElementById("btnTarik").style.display = "inline-block";
                        document.getElementById("btnTarik").disabled = true;
                        document.getElementById("btnTarik").innerText = "MENUNGGU PEMAIN...";
                        document.getElementById("btnGas").style.display = "none";
                    } else {
                        document.getElementById("btnTarik").style.display = "inline-block";
                        document.getElementById("btnTarik").disabled = false;
                        document.getElementById("btnTarik").innerText = "TARIK KARTU";
                        document.getElementById("btnGas").style.display = "none";
                    }
                }
            });

            document.getElementById("btnGas").onclick = async () => {
                const s = await getDoc(doc(db, "rooms", rId));
                let ps = s.data().players;
                let mIdx = ps.findIndex(p => p.id === pId);
                ps[mIdx].ready = true;
                await updateDoc(doc(db, "rooms", rId), { players: ps });
            };

            document.getElementById("btnTarik").onclick = async () => {
                const s = await getDoc(doc(db, "rooms", rId));
                let d = s.data(); let ps = d.players; let mIdx = ps.findIndex(p => p.id === pId);
                let max = d.mode === "spirit" ? 3 : 4;
                if(ps[mIdx].cards.length < max) {
                    ps[mIdx].cards.push(Math.floor(Math.random()*7)+"/"+Math.floor(Math.random()*7));
                    await updateDoc(doc(db, "rooms", rId), { players: ps });
                } else { alert("Maksimal " + max + " kartu!"); }
            };

            document.getElementById("btnMainLagi").onclick = async () => {
                const s = await getDoc(doc(db, "rooms", rId));
                let ps = s.data().players;
                ps.forEach(p => { p.cards = []; p.ready = false; });
                await updateDoc(doc(db, "rooms", rId), { players: ps });
            };
        }

        document.getElementById("btnBuat").onclick = async () => {
            const n = document.getElementById("pName").value;
            if(!n) return alert("Nama!");
            const rId = Math.random().toString(36).substring(2, 7).toUpperCase();
            await setDoc(doc(db, "rooms", rId), { mode: document.getElementById("gameMode").value, players: [{ id: pId, name: n, cards: [], ready: false }] });
            aktifkanRoom(rId);
        };

        document.getElementById("btnGabung").onclick = async () => {
            const n = document.getElementById("pName").value;
            const rId = document.getElementById("rCodeInput").value.toUpperCase();
            if(!n || !rId) return alert("Lengkapi data!");
            const s = await getDoc(doc(db, "rooms", rId));
            if(!s.exists()) return alert("Room tidak ada!");
            let ps = s.data().players;
            if(!ps.find(p => p.id === pId)) { ps.push({ id: pId, name: n, cards: [], ready: false }); await updateDoc(doc(db, "rooms", rId), { players: ps }); }
            aktifkanRoom(rId);
        };
    </script>
</body>
</html>
