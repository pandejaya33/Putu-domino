<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Domino Mystic - Ultimate Edition</title>
    <style>
        html, body { overscroll-behavior-y: contain; overflow: hidden; position: fixed; width: 100%; height: 100%; background: radial-gradient(circle, #0a4d28 0%, #052915 100%); color: white; font-family: sans-serif; margin: 0; }
        body { display: flex; flex-direction: column; align-items: center; }
        .box { background: rgba(0,0,0,0.9); padding: 25px; border-radius: 20px; border: 2px solid #ffd700; margin-top: 20px; text-align: center; width: 300px; display: flex; flex-direction: column; gap: 10px; }
        input, select { padding: 12px; border-radius: 8px; border: none; text-align: center; font-weight: bold; }
        .btn-gold { background: linear-gradient(#ffd700, #b8860b); color: #000; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; transition: 0.3s; font-size: 16px; }
        .btn-gold:disabled { background: #444; color: #888; cursor: not-allowed; filter: grayscale(1); }
        .btn-ai { background: linear-gradient(#00c6ff, #0072ff); color: white; }
        
        #modeDisplay { background: #ffd700; color: #000; padding: 5px 15px; border-radius: 0 0 15px 15px; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        #turnIndicator { color: #ffd700; font-size: 1em; font-weight: bold; margin: 10px 0; }
        #playerList { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 10px; margin-bottom: 10px; font-size: 11px; border: 1px solid #ffd700; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
        .player-name { padding: 4px 8px; background: #333; color: #fff; border-radius: 15px; }
        .player-name.active-turn { background: #ffd700; color: #000; font-weight: bold; }

        .card-container { position: relative; width: 75px; height: 130px; margin: 8px; touch-action: none; user-select: none; }
        .domino-card { background: #ffcc00; border: 2px solid #000; border-radius: 12px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-around; align-items: center; position: absolute; }
        .card-half { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 45px; height: 45px; gap: 3px; }
        .dot { background: #cc0000; border-radius: 50%; width: 10px; height: 10px; visibility: hidden; }
        .dot.active { visibility: visible; }
        .line { width: 90%; height: 3px; background: #000; }
        .card-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; border: 2px solid #ffd700; border-radius: 12px; z-index: 10; display: flex; justify-content: center; align-items: center; font-size: 50px; color: #cc0000; font-weight: bold; touch-action: none; transition: opacity 0.3s; }
        .card-overlay.opened { opacity: 0; pointer-events: none; }
        #voteBox { background: #cc0000; padding: 10px; border-radius: 10px; margin: 10px; display: none; z-index: 100; }
    </style>
</head>
<body>

    <div id="lobby" class="box">
        <h1 style="color:#ffd700; margin:0; font-size: 24px;">DOMINO MYSTIC</h1>
        <input type="text" id="pName" placeholder="Nama Kamu">
        <input type="text" id="rCodeInput" placeholder="Kode Room">
        <select id="gameMode">
            <option value="spirit">Mode Spirit (Max 3)</option>
            <option value="bererong">Mode Bererong (Max 4)</option>
        </select>
        <button id="btnBuat" class="btn-gold">BUAT ROOM</button>
        <button id="btnGabung" class="btn-gold" style="background: #444; color: white;">GABUNG</button>
        <hr style="width:100%; border: 0.5px solid #333;">
        <button id="btnAI" class="btn-gold btn-ai">MAIN VS KOMPUTER ðŸ¤–</button>
    </div>

    <div id="gameRoom" style="display:none; text-align:center; width: 100%;">
        <div id="modeDisplay">MODE: -</div>
        <div id="voteBox">
            <div id="voteMsg" style="font-size: 13px; margin-bottom: 5px;"></div>
            <button onclick="sendVote(true)" style="background:green; color:white; border:none; padding:8px 12px;">YA</button>
            <button onclick="sendVote(false)" style="background:black; color:white; border:none; padding:8px 12px;">TIDAK</button>
        </div>
        <h2 id="displayKode" style="color:#ffd700; margin: 5px 0;"></h2>
        <div id="turnIndicator">Menunggu...</div>
        <div id="playerList"></div>
        <div id="cardArea" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
        <div id="actionArea" style="margin-top:15px;">
            <button id="btnTarik" class="btn-gold" style="width:220px;">TARIK KARTU</button>
            <button id="btnGas" class="btn-gold" style="width:220px; display:none; background: #00ff00;">GAS! ðŸš€</button>
        </div>
        <button id="btnMainLagi" style="background: white; color: black; padding: 8px 15px; border-radius: 8px; font-weight: bold; border: none; margin-top: 15px;">RESET GAME</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDt4C2gQuyCS28359YP0nryXpv_ASqra8U", authDomain: "putu-domino-7fa82.firebaseapp.com", projectId: "putu-domino-7fa82", storageBucket: "putu-domino-7fa82.firebasestorage.app", messagingSenderId: "721819699355", appId: "1:721819699355:web:feec9dcc605643d3bcde3e" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let curRoom = ""; let pId = Math.random().toString(36).substring(7);
        let isAI = false;
        const dotPatterns = [[], [4], [0, 8], [0, 4, 8], [0, 2, 6, 8], [0, 2, 4, 6, 8], [0, 3, 6, 2, 5, 8]];
        const sfx = { draw: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'), flip: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3') };

        function generateDeck() {
            let deck = [];
            for (let i = 0; i <= 6; i++) { for (let j = i; j <= 6; j++) { deck.push(`${i}/${j}`); } }
            return deck.sort(() => Math.random() - 0.5);
        }

        function createDots(num) {
            let html = '<div class="card-half">';
            const pattern = dotPatterns[num];
            for(let i=0; i<9; i++) { html += `<div class="dot ${pattern.includes(i) ? 'active' : ''}"></div>`; }
            return html + '</div>';
        }

        function renderLocal(d) {
            const players = d.players;
            const me = players.find(p => p.id === pId);
            const activeP = players[d.turnIndex];
            document.getElementById("turnIndicator").innerText = (activeP.id === pId) ? "GILIRAN ANDA!" : "GILIRAN: " + activeP.name;
            document.getElementById("playerList").innerHTML = players.map((p, i) => `<span class="player-name ${i === d.turnIndex ? 'active-turn' : ''}">${p.name} ${p.cards.length} KRT</span>`).join('');
            document.getElementById("cardArea").innerHTML = me.cards.map((c, i) => {
                const [t, b] = c.split('/');
                return `<div class="card-container"><div class="domino-card">${createDots(parseInt(t))}<div class="line"></div>${createDots(parseInt(b))}</div><div class="card-overlay" onpointerdown="startAnyPeel(event, this)">?</div></div>`;
            }).join('');
            const isMyTurn = (activeP.id === pId);
            document.getElementById("btnTarik").disabled = !isMyTurn || (me.cards.length >= (d.mode === "spirit" ? 3 : 4));
            
            if (!isMyTurn && isAI) {
                setTimeout(() => { 
                    const max = d.mode === "spirit" ? 3 : 4;
                    if (activeP.cards.length < max) {
                        activeP.cards.push(d.deck.pop());
                        sfx.draw.play();
                    }
                    d.turnIndex = (d.turnIndex + 1) % d.players.length;
                    renderLocal(d);
                }, 1500);
            }
        }

        function aktifkanRoom(rId) {
            curRoom = rId; document.getElementById("lobby").style.display = "none"; document.getElementById("gameRoom").style.display = "block";
            onSnapshot(doc(db, "rooms", rId), (snap) => {
                if(!snap.exists() || isAI) return;
                const d = snap.data(); const me = d.players.find(p => p.id === pId); const activeP = d.players[d.turnIndex];
                document.getElementById("displayKode").innerText = "KODE: " + rId;
                document.getElementById("modeDisplay").innerText = "MODE: " + d.mode;
                document.getElementById("turnIndicator").innerText = (activeP.id === pId) ? "GILIRAN ANDA!" : "GILIRAN: " + activeP.name;
                const vb = document.getElementById("voteBox");
                if (d.resetVote && d.resetVote.status === "pending") { vb.style.display = "block"; document.getElementById("voteMsg").innerText = d.resetVote.by + " minta reset?"; } else { vb.style.display = "none"; }
                document.getElementById("playerList").innerHTML = d.players.map((p, i) => `<span class="player-name ${i === d.turnIndex ? 'active-turn' : ''}">${p.name} ${p.ready?'âœ“':''}</span>`).join('');
                if(me) {
                    document.getElementById("cardArea").innerHTML = me.cards.map((c, i) => {
                        const [t, b] = c.split('/');
                        return `<div class="card-container"><div class="domino-card">${createDots(parseInt(t))}<div class="line"></div>${createDots(parseInt(b))}</div><div class="card-overlay" onpointerdown="startAnyPeel(event, this)">?</div></div>`;
                    }).join('');
                    if (me.cards.length === 1 && !me.ready) { document.getElementById("btnTarik").style.display = "none"; document.getElementById("btnGas").style.display = "inline-block"; }
                    else { document.getElementById("btnTarik").style.display = "inline-block"; document.getElementById("btnGas").style.display = "none"; document.getElementById("btnTarik").disabled = (activeP.id !== pId) || (me.cards.length >= (d.mode === "spirit" ? 3 : 4)); }
                }
            });
        }

        window.startAnyPeel = function(e, el) {
            if (e.cancelable) e.preventDefault();
            const startX = e.clientX || e.touches[0].clientX; const startY = e.clientY || e.touches[0].clientY;
            function onMove(me) {
                const curX = me.clientX || (me.touches ? me.touches[0].clientX : me.clientX);
                const curY = me.clientY || (me.touches ? me.touches[0].clientY : me.clientY);
                const dist = Math.sqrt(Math.pow(curX - startX, 2) + Math.pow(curY - startY, 2));
                const progress = Math.min(100, (dist / 80) * 100);
                el.style.clipPath = `circle(${100 - progress}% at ${startX - el.getBoundingClientRect().left}px ${startY - el.getBoundingClientRect().top}px)`;
                if (dist > 80) { el.classList.add('opened'); sfx.flip.play(); cleanup(); }
            }
            function cleanup() { window.removeEventListener('pointermove', onMove); window.removeEventListener('touchmove', onMove); }
            window.addEventListener('pointermove', onMove); window.addEventListener('touchmove', onMove, { passive: false });
            window.addEventListener('pointerup', cleanup); window.addEventListener('touchend', cleanup);
        };

        document.getElementById("btnAI").onclick = () => {
            isAI = true; let name = document.getElementById("pName").value || "Pemain";
            document.getElementById("lobby").style.display = "none";
            document.getElementById("gameRoom").style.display = "block";
            document.getElementById("displayKode").innerText = "MODE: VS KOMPUTER";
            const d = { mode: "spirit", players: [{id:pId, name:name, cards:[], ready:false}, {id:"bot", name:"KOMPUTER ðŸ¤–", cards:[], ready:false}], deck: generateDeck(), turnIndex: 0 };
            renderLocal(d);
            document.getElementById("btnTarik").onclick = () => {
                if (d.players[d.turnIndex].id === pId) {
                    d.players[d.turnIndex].cards.push(d.deck.pop()); sfx.draw.play();
                    d.turnIndex = (d.turnIndex + 1) % d.players.length; renderLocal(d);
                }
            };
            document.getElementById("btnMainLagi").onclick = () => { location.reload(); };
        };

        // MULTIPLAYER ACTIONS
        document.getElementById("btnBuat").onclick = async () => {
            const n = document.getElementById("pName").value; if(!n) return;
            const rId = Math.random().toString(36).substring(2, 7).toUpperCase();
            await setDoc(doc(db, "rooms", rId), { mode: document.getElementById("gameMode").value, players: [{id:pId, name:n, cards:[], ready:false}], deck: generateDeck(), turnIndex:0 });
            aktifkanRoom(rId);
        };

        document.getElementById("btnTarik").onclick = async () => {
            if(isAI) return;
            const s = await getDoc(doc(db, "rooms", curRoom)); let d = s.data(); let ps = d.players;
            ps[d.turnIndex].cards.push(d.deck.pop()); sfx.draw.play();
            await updateDoc(doc(db, "rooms", curRoom), { players: ps, deck: d.deck, turnIndex: (d.turnIndex + 1) % ps.length });
        };

        document.getElementById("btnGas").onclick = async () => {
            const s = await getDoc(doc(db, "rooms", curRoom)); let ps = s.data().players;
            ps.find(p => p.id === pId).ready = true; sfx.flip.play();
            await updateDoc(doc(db, "rooms", curRoom), { players: ps });
        };

        document.getElementById("btnGabung").onclick = async () => {
            const n = document.getElementById("pName").value; const rId = document.getElementById("rCodeInput").value.toUpperCase();
            const s = await getDoc(doc(db, "rooms", rId)); if(!s.exists()) return;
            let ps = s.data().players; if(!ps.find(p => p.id === pId)) { ps.push({id:pId, name:n, cards:[], ready:false}); await updateDoc(doc(db, "rooms", rId), { players: ps }); }
            aktifkanRoom(rId);
        };
    </script>
</body>
</html>
