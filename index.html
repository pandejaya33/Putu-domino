<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Domino Mystic - Vote Reset Edition</title>
    <style>
        :root {
            --gold: #ffd700;
            --deep-gold: #b8860b;
            --ivory: #ffcc00;
            --felt-green: radial-gradient(circle, #0a4d28 0%, #052915 100%);
        }

        html, body { 
            overscroll-behavior-y: contain; overflow: hidden; position: fixed; 
            width: 100%; height: 100%; margin: 0; font-family: 'Georgia', serif;
            background: var(--felt-green); color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .box { 
            background: rgba(0,0,0,0.9); padding: 30px; border-radius: 25px; 
            border: 2px solid var(--gold); text-align: center; width: 300px; 
            z-index: 10; backdrop-filter: blur(15px);
            display: flex; flex-direction: column; align-items: center;
        }

        input, select { 
            width: 90%; padding: 12px; margin-bottom: 10px; border-radius: 10px; 
            border: 1px solid #444; background: #111; color: var(--gold); font-weight: bold; text-align: center;
        }

        .btn-gold { 
            width: 100%; background: linear-gradient(var(--gold), var(--deep-gold)); 
            color: #000; padding: 15px; border-radius: 12px; font-weight: bold; 
            border: none; cursor: pointer; font-size: 16px; text-transform: uppercase;
            box-shadow: 0 4px 0 #665200; transition: 0.2s; margin: 5px 0;
        }

        .btn-gold:disabled {
            background: #333; color: #666; box-shadow: none; cursor: not-allowed; opacity: 0.6; filter: grayscale(1);
        }

        #cardArea { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; width: 100%; max-width: 400px; margin: 20px auto; }
        .card-container { position: relative; width: 85px; height: 145px; perspective: 1000px; z-index: 10; }
        
        @keyframes throwCard {
            0% { transform: scale(0) rotate(0deg) translate(-50%, -50%); opacity: 0; position: fixed; top: 50%; left: 50%; }
            100% { transform: scale(1) rotate(360deg) translate(0, 0); opacity: 1; position: relative; top: auto; left: auto; }
        }
        .thrown { animation: throwCard 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .domino-card { 
            background: var(--ivory); border: 2px solid #000; border-radius: 12px; 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: space-around; align-items: center; position: absolute;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .card-half { 
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); 
            width: 60px; height: 60px; align-items: center; justify-items: center; position: relative;
        }
        .dot { background: #cc0000; border-radius: 50%; visibility: hidden; }
        .dot.active { visibility: visible; }
        
        .size-1 { 
            width: 38px; height: 38px; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); visibility: visible !important; 
        }
        .size-mid { width: 16px; height: 16px; }
        .size-small { width: 12px; height: 12px; }

        .line { width: 80%; height: 3px; background: #000; }

        .card-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; border: 2px solid var(--gold); border-radius: 12px; 
            z-index: 15; cursor: pointer; transform-origin: top left;
            transition: transform 0.1s linear, opacity 0.3s;
        }
        .card-overlay.opened { opacity: 0; pointer-events: none; }

        #roomUI { width: 100%; text-align: center; display: none; }
        .player-badge { padding: 8px 15px; background: rgba(0,0,0,0.6); border-radius: 20px; border: 1px solid var(--gold); margin: 5px; font-size: 14px; }
        .active-turn { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }
        #voteStatus { font-size: 12px; color: #ff4444; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="lobby" class="box">
        <h1 style="color:var(--gold); margin:0;">DOMINO MYSTIC</h1>
        <p style="font-size: 10px; color: #888; margin-bottom: 20px;">ELEGANT EDITION</p>
        <input type="text" id="pName" placeholder="NAMA PEMAIN">
        <input type="text" id="rCodeInput" placeholder="KODE ROOM (UNTUK GABUNG)">
        <select id="gameMode">
            <option value="spirit">MODE SPIRIT (MAX 3)</option>
            <option value="bererong">MODE BERERONG (MAX 4)</option>
        </select>
        <button id="btnBuat" class="btn-gold">BUAT ROOM</button>
        <button id="btnGabung" class="btn-gold" style="background:#000; color:var(--gold); border:1px solid var(--gold);">GABUNG</button>
    </div>

    <div id="roomUI">
        <div style="background:var(--gold); color:#000; padding:10px; font-weight:bold; margin-bottom:20px;" id="modeText">MODE: -</div>
        <h2 id="displayRoomCode" style="color:var(--gold); letter-spacing: 2px;"></h2>
        <div id="playerList" style="display:flex; justify-content:center; flex-wrap:wrap;"></div>
        <div id="cardArea"></div>
        <div style="margin-top:20px; display:flex; flex-direction:column; align-items:center;">
            <button id="btnTarik" class="btn-gold" style="width:200px;">TARIK KARTU</button>
            <button id="btnGas" class="btn-gold" style="width:200px; display:none;">GAS! ðŸš€</button>
            <p id="turnMsg" style="font-style:italic; margin-top:10px;"></p>
            
            <button id="btnReset" style="background:none; color:var(--gold); border:none; text-decoration:underline; margin-top:20px; cursor:pointer;">RESET PERMAINAN</button>
            <div id="voteStatus"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDt4C2gQuyCS28359YP0nryXpv_ASqra8U", authDomain: "putu-domino-7fa82.firebaseapp.com", projectId: "putu-domino-7fa82", storageBucket: "putu-domino-7fa82.firebasestorage.app", messagingSenderId: "721819699355", appId: "1:721819699355:web:feec9dcc605643d3bcde3e" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let curRoom = ""; let pId = Math.random().toString(36).substring(7);
        const dotPatterns = [[], [4], [0, 8], [0, 4, 8], [0, 2, 6, 8], [0, 2, 4, 6, 8], [0, 2, 3, 5, 6, 8]];

        const sfxClick = new Audio('https://www.soundjay.com/button/sounds/button-21.mp3');
        function playClick() { sfxClick.currentTime = 0; sfxClick.play().catch(() => {}); }

        function createDots(num) {
            let html = '<div class="card-half">';
            if (num === 1) { html += `<div class="dot active size-1"></div>`; } 
            else {
                const pattern = dotPatterns[num];
                const size = num >= 4 ? 'size-small' : 'size-mid';
                for(let i=0; i<9; i++) html += `<div class="dot ${pattern.includes(i)?'active':''} ${size}"></div>`;
            }
            return html + '</div>';
        }

        window.initPeel = function(e, el) {
            if(e.cancelable) e.preventDefault();
            const rect = el.getBoundingClientRect();
            const handleMove = (me) => {
                const y = (me.clientY || me.touches[0].clientY) - rect.top;
                const percent = Math.min(100, (y / rect.height) * 100);
                el.style.transform = `rotateX(${percent * 0.8}deg) translateY(${percent}px)`;
                if(percent > 80) { el.classList.add('opened'); stop(); }
            };
            const stop = () => { window.removeEventListener('pointermove', handleMove); window.removeEventListener('touchmove', handleMove); };
            window.addEventListener('pointermove', handleMove);
            window.addEventListener('touchmove', handleMove, {passive:false});
            window.addEventListener('pointerup', stop); window.addEventListener('touchend', stop);
        };

        async function performReset(d, rId) {
            let deck = []; for(let i=0; i<=6; i++) for(let j=i; j<=6; j++) deck.push(`${i}/${j}`);
            deck.sort(() => Math.random()-0.5);
            d.players.forEach(p => { p.cards = [deck.pop()]; p.ready = false; });
            await updateDoc(doc(db, "rooms", rId), { 
                players: d.players, 
                deck: deck, 
                turnIndex: 0, 
                resetVotes: [] 
            });
            document.getElementById("cardArea").innerHTML = "";
        }

        function render(d, rId) {
            document.getElementById("modeText").innerText = "MODE: " + d.mode.toUpperCase();
            document.getElementById("displayRoomCode").innerText = "KODE ROOM: " + rId;
            const me = d.players.find(p => p.id === pId);
            const everyoneReady = d.players.every(p => p.ready);

            document.getElementById("playerList").innerHTML = d.players.map((p, i) => `
                <div class="player-badge ${everyoneReady && i === d.turnIndex ? 'active-turn' : ''}">
                    ${p.name} (${p.cards.length}) ${p.ready?'âœ“':''}
                </div>
            `).join('');

            const area = document.getElementById("cardArea");
            const count = area.querySelectorAll('.card-container').length;
            if(me.cards.length > count) {
                const c = me.cards[me.cards.length-1].split('/');
                area.insertAdjacentHTML('beforeend', `
                    <div class="card-container thrown">
                        <div class="domino-card">${createDots(parseInt(c[0]))}<div class="line"></div>${createDots(parseInt(c[1]))}</div>
                        <div class="card-overlay" onpointerdown="initPeel(event, this)"></div>
                    </div>
                `);
            }

            // LOGIKA VOTE STATUS
            const votes = d.resetVotes || [];
            if(votes.length > 0) {
                document.getElementById("voteStatus").innerText = `âš ï¸ Vote Reset: ${votes.length}/${d.players.length}`;
            } else {
                document.getElementById("voteStatus").innerText = "";
            }

            const maxCards = d.mode === 'spirit' ? 3 : 4;
            const isMyTurn = everyoneReady && (d.players[d.turnIndex].id === pId);
            const btnTarik = document.getElementById("btnTarik");

            if(me.cards.length === 1 && !me.ready) {
                btnTarik.style.display = "none";
                document.getElementById("btnGas").style.display = "block";
            } else {
                btnTarik.style.display = "block";
                document.getElementById("btnGas").style.display = "none";
                btnTarik.disabled = !isMyTurn || me.cards.length >= maxCards;
            }
            document.getElementById("turnMsg").innerText = !everyoneReady ? "Menunggu pemain GAS..." : (isMyTurn ? "GILIRAN ANDA!" : "Giliran: " + d.players[d.turnIndex].name);
        }

        document.getElementById("btnBuat").onclick = async () => {
            playClick();
            const rId = Math.random().toString(36).substring(2,7).toUpperCase();
            let deck = []; for(let i=0; i<=6; i++) for(let j=i; j<=6; j++) deck.push(`${i}/${j}`);
            deck.sort(() => Math.random()-0.5);
            const firstCard = deck.pop(); 
            await setDoc(doc(db, "rooms", rId), {
                mode: document.getElementById("gameMode").value,
                players: [{id:pId, name:document.getElementById("pName").value || "Player", cards:[firstCard], ready:false}],
                deck: deck, turnIndex: 0, resetVotes: []
            });
            start(rId);
        };

        document.getElementById("btnGabung").onclick = async () => {
            playClick();
            const rId = document.getElementById("rCodeInput").value.toUpperCase();
            const roomRef = doc(db, "rooms", rId);
            const s = await getDoc(roomRef);
            if(s.exists()){
                let d = s.data();
                if(!d.players.find(p => p.id === pId)){
                    const initialCard = d.deck.pop(); 
                    d.players.push({id:pId, name:document.getElementById("pName").value || "Guest", cards:[initialCard], ready:false});
                    await updateDoc(roomRef, {players: d.players, deck: d.deck});
                }
                start(rId);
            }
        };

        function start(rId) {
            curRoom = rId; document.getElementById("lobby").style.display="none"; document.getElementById("roomUI").style.display="block";
            onSnapshot(doc(db, "rooms", rId), (s) => { if(s.exists()) render(s.data(), rId); });
        }

        document.getElementById("btnTarik").onclick = async () => {
            playClick();
            const roomRef = doc(db, "rooms", curRoom);
            const s = await getDoc(roomRef);
            let d = s.data();
            if(d.deck.length > 0) {
                const pulled = d.deck.pop();
                const myIdx = d.players.findIndex(p => p.id === pId);
                d.players[myIdx].cards.push(pulled);
                await updateDoc(roomRef, { players: d.players, deck: d.deck, turnIndex: (d.turnIndex + 1) % d.players.length });
            }
        };

        document.getElementById("btnGas").onclick = async () => {
            playClick();
            const s = await getDoc(doc(db, "rooms", curRoom)); let d = s.data();
            d.players.find(p => p.id === pId).ready = true;
            await updateDoc(doc(db, "rooms", curRoom), { players: d.players });
        };

        // SISTEM VOTE RESET
        document.getElementById("btnReset").onclick = async () => {
            playClick();
            const roomRef = doc(db, "rooms", curRoom);
            const s = await getDoc(roomRef);
            let d = s.data();
            let votes = d.resetVotes || [];
            
            if(!votes.includes(pId)) {
                votes.push(pId);
                if(votes.length >= d.players.length) {
                    await performReset(d, curRoom);
                } else {
                    await updateDoc(roomRef, { resetVotes: votes });
                }
            } else {
                alert("Anda sudah memberikan suara reset.");
            }
        };
    </script>
</body>
</html>
